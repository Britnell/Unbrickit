---
import Page from '../../components/Page.astro';

/* 
todo : 
- chime
- complementary / analogous colours
- random theme
*/
---

<Page alpine>
  <script is:inline>
    const fonts =
      'system,humanist,industrial,serif,geometric,rounded,mono-serif,mono-code,didone,antique,old-style,transitional'.split(
        ',',
      );

    function getTime() {
      const d = new Date();
      const h = d.getHours();
      const m = d.getMinutes();
      const s = d.getSeconds();
      return [h, m, s];
    }

    function display(h, m) {
      const _h = String(h).padStart(2, '0');
      const _m = String(m).padStart(2, '0');
      return `${_h}:${_m}`;
    }

    const defaults = {
      hue: 60,
      weight: 800,
      fontSize: 26,
      shufflePeriod: 5,
    };

    const shufflePeriodOptions = [1, 5, 10, 15, 20, 60];

    document.addEventListener('alpine:init', () => {
      Alpine.data('digital', () => ({
        time: ':',
        shuffleEnabled: false,
        shufflePeriod: defaults.shufflePeriod,
        shuffleLast: null,
        font: fonts[0],
        weight: defaults.weight,
        showMenu: true,
        hue: defaults.hue,
        get colors() {
          const h = parseInt(this.hue);
          const a = `hsl(${h}, 100%, 80%)`;
          const b = `hsl(${(h + 360 - 25) % 360}, 60%, 35%)`;
          const bg = this.darkMode ? b : a;
          const fg = this.darkMode ? a : b;
          return { bg: bg, text: fg };
        },
        fontSize: defaults.fontSize,
        timer: null,
        wakeLock: null,
        isWakeLocked: false,
        init() {
          this.loop();
          this.font = localStorage.getItem('font') || fonts[0];
          this.weight = localStorage.getItem('weight') || defaults.weight;
          this.fontSize = localStorage.getItem('fontSize') || defaults.fontSize;
          this.shuffleEnabled = localStorage.getItem('shuffleEnabled') === 'true' || false;
          this.shufflePeriod = parseInt(localStorage.getItem('shufflePeriod') || defaults.shufflePeriod);
          this.darkMode = localStorage.getItem('darkMode') === 'true' || false;

          // sync storage
          Alpine.effect(() => {
            localStorage.setItem('shuffleEnabled', this.shuffleEnabled);
            localStorage.setItem('font', this.font);
            localStorage.setItem('weight', this.weight);
            localStorage.setItem('hue', this.hue);
            localStorage.setItem('fontSize', this.fontSize);
            localStorage.setItem('shufflePeriod', this.shufflePeriod);
            localStorage.setItem('darkMode', this.darkMode);
          });

          // restart on focus
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
              this.loop();
            }
          });
        },
        loop() {
          if (this.timer) clearTimeout(this.timer);
          const [h, m, s] = getTime();
          this.time = display(h, m);
          const rem = 60 - s;
          if (this.shuffleEnabled) {
            const t = Math.floor(m / this.shufflePeriod);
            if (t !== this.shuffleLast) {
              this.shuffleLast = t;
              this.shuffle();
            }
          }

          this.timer = setTimeout(() => {
            this.loop();
          }, rem * 1000);
        },
        shuffle() {
          const f = Math.floor(Math.random() * (fonts.length - 1));
          const w = Math.floor(Math.random() * 9) * 100 + 100;
          this.font = fonts[f];
          this.weight = w;
          this.hue = Math.floor(Math.random() * 360);
        },
        toggleFullscreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
          } else {
            document.exitFullscreen();
          }
        },
        toggleUnlocked() {
          if (this.wakeLock) {
            this.wakeLock.release();
            this.wakeLock = null;
          } else {
            navigator.wakeLock
              .request()
              .then((wakeLock) => {
                this.wakeLock = wakeLock;
                // this.wakeLock.addEventListener('release', () => {});
              })
              .catch(() => {
                this.isWakeLock = null;
              });
          }
        },
      }));
    });
  </script>
  <div class="relative h-screen" x-data="digital">
    <!-- Clock Display -->
    <div
      :class="`${font} h-screen w-full grid place-items-center overflow-hidden leading-none transition-colors duration-1000`"
      :style="`
        font-weight: ${weight};
        font-size: ${fontSize}vw;
        background-color: ${colors.bg};
        color: ${colors.text};`"
    >
      <span class="mb-[5vh]" x-text="time"></span>
    </div>

    <!-- Settings Button -->
    <div class="absolute top-3 right-3 z-10">
      <button
        @click="showMenu = !showMenu"
        class="p-4 text-xl bg-transparent border-none transition-transform hover:scale-110 z-10"
        aria-label="Settings"
        :style="`color: ${colors.text};`"
      >
        ...
      </button>

      <!-- Settings Menu -->
      <div
        class="absolute w-[16rem] top-0 right-0 bg-[#fff8] rounded-lg p-4 shadow-lg z-20 flex flex-col gap-3 max-h-[calc(100vh-4rem)] overflow-y-auto text-xs text-gray-600"
        x-show="showMenu"
        @click.away="showMenu = false"
      >
        <!-- Random Mode Toggle -->
        <div class="flex gap-2 items-center">
          <input type="checkbox" id="random-mode" x-model="shuffleEnabled" class="" />
          <label for="random-mode" class="">Shuffle</label>
        </div>

        <!-- custom -->

        <template x-if="!shuffleEnabled">
          <div class="contents">
            <h3 class="font-bold">Font</h3>
            <!-- Font Selector -->
            <div class="">
              <label for="font-select" class="flex justify-between items-center mb-1"> Theme: </label>
              <select
                id="font-select"
                x-model="font"
                class="w-full p-2 border border-gray-200 rounded-md bg-[#fff5]"
                x-init="$nextTick(() => { $el.value = font })"
              >
                <template x-for="f in fonts" :key="f">
                  <option :value="f" x-text="f.charAt(0).toUpperCase() + f.slice(1)"></option>
                </template>
              </select>
            </div>

            <!-- Weight Slider -->
            <div class="">
              <label for="weight-slider" class="flex justify-between items-center">
                Weight: <span x-text="weight" class="font-mono"></span>
              </label>
              <input type="range" id="weight-slider" x-model="weight" min="100" max="900" step="100" />
            </div>

            <!-- Size Slider -->
            <div class="">
              <label for="size-slider" class="flex justify-between items-center">
                Size: <span x-text="fontSize + 'vw'" class="font-mono"></span>
              </label>
              <input type="range" id="size-slider" x-model="fontSize" min="5" max="45" step="1" />
            </div>

            <h3 class="font-bold">Color</h3>

            <!-- Hue Slider -->
            <div class="">
              <label for="hue-slider" class="flex justify-between items-center">
                Hue: <span x-text="hue + 'Â°'" class="font-mono"></span>
              </label>
              <input type="range" id="hue-slider" x-model="hue" min="0" max="360" step="1" />
            </div>

            <!-- Brightness  -->

            <!-- Dark Mode Toggle -->
            <div class="flex gap-2 items-center">
              <input type="checkbox" id="dark-mode" x-model="darkMode" class="" />
              <label for="dark-mode" class="">Dark Mode</label>
            </div>
          </div>

          <!--  -->
        </template>

        <template x-if="shuffleEnabled">
          <div>
            <!-- Shuffle Period Selector -->
            <div class="flex flex-col gap-1" x-show="shuffleEnabled">
              <label for="shuffle-select" class=""> Change every: </label>
              <select
                id="shuffle-select"
                x-model="shufflePeriod"
                class="w-full p-2 text-sm border border-gray-200 rounded-md"
                x-init="$nextTick(() => { $el.value = shufflePeriod })"
              >
                <template x-for="period in shufflePeriodOptions" :key="period">
                  <option :value="period" x-text="`${period} min`"></option>
                </template>
              </select>
            </div>
          </div>
        </template>

        <button class="px-2 py-1 border border-gray-400 rounded-md" @click="toggleFullscreen()"
          >Switch Fullscreen</button
        >

        <button
          class="px-2 py-1 border border-gray-400 rounded-md"
          @click="toggleUnlocked()"
          x-text="wakeLock ? 'Release screen lock' : 'Keep screen unlocked' "></button>
      </div>
    </div>
  </div>

  <style>
    /* Fonts  */

    .system {
      font-family: system-ui, sans-serif;
    }
    .transitional {
      font-family: Charter, 'Bitstream Charter', 'Sitka Text', Cambria, serif;
    }
    .old-style {
      font-family: 'Iowan Old Style', 'Palatino Linotype', 'URW Palladio L', P052, serif;
    }
    .humanist {
      font-family: Seravek, 'Gill Sans Nova', Ubuntu, Calibri, 'DejaVu Sans', source-sans-pro, sans-serif;
    }
    .geometric {
      font-family: Avenir, Montserrat, Corbel, 'URW Gothic', source-sans-pro, sans-serif;
    }
    .classical {
      font-family: Optima, Candara, 'Noto Sans', source-sans-pro, sans-serif;
    }
    .neo-grotesque {
      font-family: Inter, Roboto, 'Helvetica Neue', 'Arial Nova', 'Nimbus Sans', Arial, sans-serif;
    }
    .mono-serif {
      font-family: 'Nimbus Mono PS', 'Courier New', monospace;
    }
    .mono-code {
      font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, 'DejaVu Sans Mono', monospace;
    }
    .industrial {
      font-family: Bahnschrift, 'DIN Alternate', 'Franklin Gothic Medium', 'Nimbus Sans Narrow', sans-serif-condensed,
        sans-serif;
    }
    .rounded {
      font-family: ui-rounded, 'Hiragino Maru Gothic ProN', Quicksand, Comfortaa, Manjari, 'Arial Rounded MT',
        'Arial Rounded MT Bold', Calibri, source-sans-pro, sans-serif;
    }
    .serif {
      font-family: Rockwell, 'Rockwell Nova', 'Roboto Slab', 'DejaVu Serif', 'Sitka Small', serif;
    }
    .antique {
      font-family: Superclarendon, 'Bookman Old Style', 'URW Bookman', 'URW Bookman L', 'Georgia Pro', Georgia, serif;
    }
    .didone {
      font-family: Didot, 'Bodoni MT', 'Noto Serif Display', 'URW Palladio L', P052, Sylfaen, serif;
    }
  </style>
</Page>
